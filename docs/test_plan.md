# OneFormer3D 测试计划

## 已完成测试

### 1. SpConv基础功能验证 (2024-01-15)
- [x] 点云数据加载与预处理
  * 实现文件：`tools/test_voxelization.py`
  * 测试结果：
    - 成功加载S3DIS数据集点云 (504,115点)
    - 验证6维特征 (XYZ + RGB)
    - 内存占用：11.54 MB
    - 数据加载稳定性良好

- [x] SpConv张量创建与验证
  * 测试项：
    - 特征形状：[504115, 6]
    - 索引形状：[504115, 4]
    - 空间形状：[429, 431, 101]
    - Batch处理支持验证

- [x] SpConv卷积操作测试
  * 验证项：
    - SubMConv3d (维持分辨率)：
      * 输入 [504115, 6] -> 输出 [504115, 32]
      * 空间形状保持：[429, 431, 101]
    - SparseConv3d (下采样)：
      * 输入 [504115, 32] -> 输出 [179952, 64]
      * 空间形状减半：[215, 216, 51]
      * 点数压缩比：35.7%

### 2. DINOv2多视图特征提取测试 (2024-01-16)
- [x] DINOv2模型加载与初始化
  * 实现文件：`oneformer3d/models/DINO_extractor.py`
  * 测试结果：
    - 成功加载DINOv2-Large模型
    - 支持torch.hub和本地加载两种方式
    - 模型设备自动适配(CPU/CUDA)

- [x] 图像特征提取验证
  * 测试项：
    - 输入图像预处理：
      * 尺寸调整：(896, 1204)
      * 标准化：ImageNet均值和标准差
    - 特征提取流程：
      * 原始特征：[1, 1024, 64, 86]
      * BiFPN处理：保持通道数1024
      * 通道降维：1024 -> 256
      * 上采样：(896, 1204)

- [x] 多视图特征可视化
  * 验证项：
    - 单视图特征处理：
      * PCA降维：256 -> 3通道
      * 特征归一化与统计
      * 可视化结果保存
    - 多视图网格展示：
      * 支持2x3网格布局
      * 特征图对齐与缩放
      * 网格图导出

### 3. 多模态特征融合测试 (2024-01-17)
- [ ] 数据同步加载验证
  * 测试要点：
    - 点云数据加载：
      * 验证点云数据完整性
      * 检查点云特征维度 (XYZ + RGB)
      * 确认点云数据范围
    - 多视图图像加载：
      * 验证图像数量完整性
      * 检查图像分辨率一致性
      * 确认图像预处理效果
    - 相机位姿加载：
      * 验证位姿矩阵格式 (4x4)
      * 检查旋转矩阵正交性
      * 确认平移向量合理性
    - 同步性验证：
      * 点云与图像时间戳对齐
      * 位姿与图像对应关系
      * 数据加载顺序一致性

- [ ] 特征提取流程验证
  * 测试项：
    - 点云体素化：
      * 验证体素大小设置 (0.33m)
      * 检查体素化后点云压缩率
      * 确认体素特征维度
    - SpConv特征提取：
      * 验证网络各层输出尺寸
      * 检查特征图分辨率变化
      * 确认最终体素特征维度
    - DINOv2特征提取：
      * 验证特征图尺寸
      * 检查特征维度 (256维)
      * 确认特征质量
      * 验证批处理正确性

- [ ] 特征投影对齐验证
  * 验证项：
    - 投影矩阵计算：
      * 验证内参矩阵正确性
      * 检查外参矩阵转换
      * 确认投影矩阵精度
    - 体素中心投影：
      * 验证投影点坐标计算
      * 检查投影点有效性
      * 确认遮挡处理正确性
    - 特征采样：
      * 验证双线性插值实现
      * 检查边界条件处理
      * 确认采样特征维度
    - 多视图一致性：
      * 验证跨视图特征一致性
      * 检查重叠区域特征
      * 确认视角变化影响

- [ ] 特征融合验证
  * 测试要点：
    - 特征预处理：
      * 验证特征归一化
      * 检查维度匹配
      * 确认特征尺度
    - 融合策略验证：
      * 测试不同融合方法：
        - 简单拼接
        - 加权平均
        - 注意力机制
      * 验证融合特征质量：
        - 特征判别性
        - 空间一致性
        - 语义保持性
    - 融合结果分析：
      * 可视化融合特征
      * 统计特征分布
      * 评估特征有效性

### 验证方法与指标

1. 数据完整性验证
   - 样本数量统计
   - 数据格式检查
   - 缺失值检测
   - 异常值识别

2. 特征质量评估
   - 特征可视化分析
     * t-SNE降维展示
     * 特征响应热图
     * 注意力权重可视化
   - 数值统计分析
     * 特征方差分析
     * 跨模态相关性
     * 特征判别度

3. 计算正确性验证
   - 数值精度检查
   - 边界条件测试
   - 随机采样验证
   - 对比基准实现

4. 性能评估
   - 内存使用监控
   - 计算时间统计
   - GPU利用率分析
   - 批处理效率

### 预期输出与验证点

1. 数据加载阶段
   - 输出数据统计信息
   - 生成数据分布报告
   - 记录异常数据

2. 特征提取阶段
   - 保存中间特征图
   - 记录网络输出统计
   - 生成特征响应图

3. 投影对齐阶段
   - 可视化投影结果
   - 输出投影精度统计
   - 记录无效投影点

4. 特征融合阶段
   - 保存融合特征图
   - 生成特征对比图
   - 输出定量评估指标

### 测试用例设计

1. 正常场景测试
   - 标准数据输入
   - 典型场景验证
   - 常规参数设置

2. 边界条件测试
   - 最大/最小点云数
   - 极端视角变化
   - 特殊场景结构

3. 异常处理测试
   - 缺失数据处理
   - 无效投影处理
   - 特征异常处理

4. 性能压力测试
   - 大规模数据处理
   - 高分辨率图像
   - 密集点云场景

### 测试环境要求

- GPU: CUDA支持
- 内存: 16GB以上
- 存储: 100GB以上
- 依赖包: 
  * torch
  * spconv
  * MinkowskiEngine
  * mmengine
  * mmdet3d 